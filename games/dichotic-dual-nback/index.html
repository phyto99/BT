<html>

  <head>
    <title>Dichotic Dual N-back</title>
    <meta charset="UTF-8">
    <meta name="description" content="Open Source Dichotic Dual N-back">
    <meta name="keywords" content="DNB, N-back, WM">
    <meta name="author" content="4skinSkywalker">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="js/jquery.min.js"></script>
    <script src="js/chartist.min.js"></script>
    <script src="js/howler.min.js"></script>

    <script src="js/popup.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/functions.js"></script>

    <link rel="stylesheet" href="css/chartist.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" media="all and (orientation:portrait)" href="css/portrait.css">
    <link rel="stylesheet" media="all and (orientation:landscape)" href="css/landscape.css">
  </head>

  <body>

    <!-- slide-menu start -->
    <ul id="navigation">

      <!-- settings start -->
      <li class="nav-item">
        <!-- sets the duration of clues -->
        <span class="range-label">Stimulus time </span>
        <span id="set-time-span" class="range-label">4000ms</span>
        <input type="range" class="slider" id="set-time" min="1500" max="15000" step="250" value="4000">
      </li>
      <li class="nav-item">
        <!-- sets the quantity of clues -->
        <span class="range-label">Matching clues </span>
        <span id="set-clues-span" class="range-label">10</span>
        <input type="range" class="slider" id="set-clues" min="5" max="30" step="5" value="10">
      </li>
      <li class="nav-item">
        <!-- sets a level of difficulty -->
        <span class="range-label">N-back level </span>
        <span id="set-level-span" class="range-label">2</span>
        <input type="range" class="slider" id="set-level" min="1" max="9" step="1" value="2">
      </li>
      <li class="nav-item">
        <!-- selects a sound for audio clues -->
        <label for="select-sound">Sounds left</label>
        <select class="option" id="select-sound-left">
          <!-- generated by JS, see initSetting within main.js -->
        </select>
      </li>
      <li class="nav-item">
        <!-- selects a sound for audio clues -->
        <label for="select-sound">Sounds right</label>
        <select class="option" id="select-sound-right">
          <!-- generated by JS, see initSetting within main.js -->
        </select>
      </li>
      <li class="nav-item">
        <!-- do you want feedback? -->
        <span class="range-label">Clue feedback? </span>
        <span id="feedback-span" class="range-label">on</span>
        <input type="range" class="slider" id="feedback" min="0" max="1" step="1" value="1">
      </li>
      <!-- settings end -->

      <!-- a brief description on how to play -->
      <li class="nav-item">
        <p>
          <span style="color: #ffd700">Controls:</span>
          <br> "A" for visual left
          <br> "S" for visual right
          <br> "K" for left audio
          <br> "L" for right audio
          <br> "P" to start/stop
          <br>
          <br>
        </p>
      </li>
    </ul>
    <!-- slide-menu end -->

    <!-- slide-menu invocation button -->
    <input type="checkbox" id="nav-trigger"><label for="nav-trigger"></label>

    <!-- training-field start -->
    <div id="site-wrap">

      <!-- a button that shows stats -->
      <button onclick="enviroment.drawChart()" style="z-index:50" class="btn-popup reflected">â˜…</button>

      <!-- left simuli shown here -->
      <div id="status-bar">
        <div id="stimuli-counter">24</div>
      </div>

      <!-- a button to start/stop the game -->
      <button onclick="game.start()" id="engine-btn" class="btn-standard">Play</button>

      <!-- the N-back grid -->
      <table id="grid">
        <tbody>
          <tr>
            <td class="heading-td">
              <div class="tile hidden"></div>
            </td>
            <td class="heading-td">
              <div class="tile center-tile">
                <p id="N-level">N = 2</p>
              </div>
            </td>
          </tr>
          <tr><td class="visual-td"><div class="tile tile-left"></div></td><td class="visual-td"><div class="tile tile-right"></div></td></tr>
        </tbody>
      </table>

      <!-- buttons to confirm clues -->
      <div id="eye-left-btn"></div>
      <div id="eye-right-btn"></div>
      <div id="ear-left-btn"></div>
      <div id="ear-right-btn"></div>
    </div>
    <!-- training-field end -->

    <script>
      // Reactive Settings Integration - Optimized
      window.settings = {
        nLevel: 2,
        stimulusTime: 4000,
        matchingClues: 10,
        soundsLeft: 'Letters English (USA)',
        soundsRight: 'Numbers English (USA)',
        feedback: true
      };
      
      // Helper to safely update DOM and game
      const safeUpdate = (id, value, spanId, gameKey) => {
        const el = document.getElementById(id);
        const span = spanId && document.getElementById(spanId);
        if (el) el.value = value;
        if (span) span.textContent = spanId === 'set-time-span' ? value + 'ms' : value;
        if (window.game && gameKey) window.game[gameKey] = value;
      };
      
      window.updateSettings = function(newSettings) {
        if (newSettings) Object.assign(window.settings, newSettings);
        
        try {
          safeUpdate('set-level', window.settings.nLevel, 'set-level-span', 'n');
          safeUpdate('set-time', window.settings.stimulusTime, 'set-time-span', 'time');
          safeUpdate('set-clues', window.settings.matchingClues, 'set-clues-span', 'clues');
          
          // Update sound dropdowns
          safeUpdate('select-sound-left', window.settings.soundsLeft, null, null);
          safeUpdate('select-sound-right', window.settings.soundsRight, null, null);
          
          // Reload audio files when sound settings change
          if (window.game) {
            if (newSettings?.soundsLeft !== undefined) {
              window.game.updateSoundsLeft();
            }
            if (newSettings?.soundsRight !== undefined) {
              window.game.updateSoundsRight();
            }
          }
          
          const feedbackEl = document.getElementById('feedback');
          const feedbackSpan = document.getElementById('feedback-span');
          if (feedbackEl) feedbackEl.value = window.settings.feedback ? 1 : 0;
          if (feedbackSpan) feedbackSpan.textContent = window.settings.feedback ? 'on' : 'off';
          if (window.game) window.game.feedback = window.settings.feedback;
          
          const nLevelEl = document.getElementById('N-level');
          if (nLevelEl) nLevelEl.textContent = 'N = ' + window.settings.nLevel;
        } catch (e) {}
      };
      
      window.repopulateGui = function() {
        try {
          window.settings.nLevel = parseInt(document.getElementById('set-level')?.value || 2);
          window.settings.stimulusTime = parseInt(document.getElementById('set-time')?.value || 4000);
          window.settings.matchingClues = parseInt(document.getElementById('set-clues')?.value || 10);
          window.settings.soundsLeft = document.getElementById('select-sound-left')?.value || 'Letters English (USA)';
          window.settings.soundsRight = document.getElementById('select-sound-right')?.value || 'Numbers English (USA)';
          window.settings.feedback = parseInt(document.getElementById('feedback')?.value || 1) === 1;
        } catch (e) {}
      };
      
      window.startGame = function() {
        if (window.game && !window.game.running) {
          window.game.start();
        }
      };
      
      window.stopGame = function() {
        if (window.game && window.game.running) {
          // Record stats BEFORE stopping (which resets the score)
          if (window.parent !== window && window.parent.gameStats) {
            var totalCorrect = window.game.score[0] + window.game.score[9] + window.game.score[3] + window.game.score[6];
            var totalMissed = window.game.score[1] + window.game.score[10] + window.game.score[4] + window.game.score[7];
            var totalWrong = window.game.score[2] + window.game.score[11] + window.game.score[5] + window.game.score[8];
            var totalAttempts = totalCorrect + totalMissed + totalWrong;
            var accuracy = totalAttempts > 0 ? totalCorrect / totalAttempts : 0;
            var wrongPositions = window.game.score[1] + window.game.score[2] + window.game.score[10] + window.game.score[11];
            var wrongSounds = window.game.score[4] + window.game.score[5] + window.game.score[7] + window.game.score[8];
            
            window.parent.gameStats.recordSession({
              score: totalCorrect,
              accuracy: accuracy,
              level: window.game.n,
              nBack: window.game.n,
              visualLeftCorrect: window.game.score[0],
              visualLeftMissed: window.game.score[1],
              visualLeftWrong: window.game.score[2],
              audioLeftCorrect: window.game.score[3],
              audioLeftMissed: window.game.score[4],
              audioLeftWrong: window.game.score[5],
              audioRightCorrect: window.game.score[6],
              audioRightMissed: window.game.score[7],
              audioRightWrong: window.game.score[8],
              visualRightCorrect: window.game.score[9],
              visualRightMissed: window.game.score[10],
              visualRightWrong: window.game.score[11],
              totalCorrect: totalCorrect,
              totalMissed: totalMissed,
              totalWrong: totalWrong,
              wrongPositions: wrongPositions,
              wrongSounds: wrongSounds,
              stimulusTime: window.game.time,
              matchingClues: window.game.clues,
              soundsLeft: window.settings?.soundsLeft || 'Letters English (USA)',
              soundsRight: window.settings?.soundsRight || 'Numbers English (USA)',
              feedback: window.game.feedback,
              sessionEnded: true,
              manualStop: true
            });
          }
          
          window.game.stop();
        }
      };
      
      // Message listener for unified system
      window.addEventListener('message', (e) => {
        if (e.data?.type === 'settingsUpdate' && e.data.settings) {
          Object.assign(window.settings, e.data.settings);
          window.updateSettings();
          window.repopulateGui();
        }
        
        if (e.data?.type === 'startGame') {
          window.startGame();
        }
        
        if (e.data?.type === 'stopGame') {
          window.stopGame();
        }
      });
    </script>
    
    <script src="js/main.js"></script>
    <script src="js/game.js"></script>
    <script>
      enviroment.init();
      game.init();
      
      // Signal to unified system that game is ready to receive settings
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'gameReady',
          gameId: 'dichotic-dual-nback'
        }, '*');
      }
    </script>
  </body>

</html>
