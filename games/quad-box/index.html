<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/quadbox.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Quad Box">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/icons/192.png">
    <title>Quad Box</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
    
    <script>
      // Reactive Settings Integration - Optimized for Svelte
      window.settings = {
        mode: 'quad',
        theme: 'dark',
        nBack: 2,
        numTrials: 35,
        trialTime: 2500,
        matchChance: 25,
        feedback: 'show',
        rotationSpeed: 35
      };
      
      // Wait for Svelte app to initialize and expose the store
      const waitForStore = () => {
        return new Promise((resolve) => {
          const check = () => {
            if (window.quadBoxStore) {
              resolve();
            } else {
              setTimeout(check, 50);
            }
          };
          check();
        });
      };
      
      window.updateSettings = function(newSettings) {
        if (newSettings) {
          Object.assign(window.settings, newSettings);
          
          // Update Svelte store directly
          waitForStore().then(() => {
            window.quadBoxStore?.updateSettings(newSettings);
          });
        }
      };
      
      window.repopulateGui = function() {
        waitForStore().then(() => {
          try {
            const current = window.quadBoxStore?.getSettings();
            if (current) {
              const mode = current.mode || 'quad';
              const gameSettings = current.gameSettings?.[mode] || {};
              
              window.settings.mode = current.mode;
              window.settings.theme = current.theme;
              window.settings.nBack = gameSettings.nBack;
              window.settings.numTrials = gameSettings.numTrials;
              window.settings.trialTime = gameSettings.trialTime;
              window.settings.feedback = current.feedback;
              window.settings.rotationSpeed = current.rotationSpeed;
            }
          } catch (e) {}
        });
      };
      
      window.startGame = function() {
        console.log('▶️ [QUAD-BOX] startGame called, dispatching event');
        window.dispatchEvent(new CustomEvent('unifiedStartGame'));
      };
      
      window.stopGame = function() {
        console.log('⏹️ [QUAD-BOX] stopGame called, dispatching event');
        window.dispatchEvent(new CustomEvent('unifiedStopGame'));
      };
      
      // Message listener for unified system
      window.addEventListener('message', (e) => {
        if (e.data?.type === 'settingsUpdate' && e.data.settings) {
          Object.assign(window.settings, e.data.settings);
          window.updateSettings(e.data.settings);
          window.repopulateGui();
        }
        
        // Handle startGame message from unified play button
        if (e.data?.type === 'startGame') {
          console.log('▶️ [QUAD-BOX] Received startGame message from unified system');
          window.startGame();
        }
        
        // Handle stopGame message from unified stop button
        if (e.data?.type === 'stopGame') {
          console.log('⏹️ [QUAD-BOX] Received stopGame message from unified system');
          window.stopGame();
        }
      });
      
      // Initialize after store is ready
      waitForStore().then(() => window.repopulateGui());
    </script>
  </body>
</html>
